// Estados posibles del bot
type BotState = 
  | 'MAIN_MENU'
  | 'BROWSING_OFFERS'
  | 'SELECTING_VENDOR'
  | 'ORDERING'
  | 'VENDOR_CHAT'
  | 'VIEWING_HOURS'
  | 'TRACKING_ORDER'
  | 'RATING';

interface UserSession {
  phone: string;
  state: BotState;
  context?: {
    selected_vendor_id?: string;
    selected_products?: any[];
    last_interaction?: string;
  };
}

// Obtener o crear sesi√≥n
async function getSession(phone: string, supabase: any): Promise<UserSession> {
  const { data } = await supabase
    .from('user_sessions')
    .select('*')
    .eq('phone', phone)
    .maybeSingle();

  if (data) {
    return {
      phone: data.phone,
      state: (data.previous_state as BotState) || 'MAIN_MENU',
      context: data.last_bot_message ? JSON.parse(data.last_bot_message) : {}
    };
  }

  // Crear nueva sesi√≥n
  const newSession: UserSession = {
    phone,
    state: 'MAIN_MENU',
    context: {}
  };
  
  await supabase
    .from('user_sessions')
    .upsert({
      phone,
      previous_state: 'MAIN_MENU',
      last_bot_message: JSON.stringify({}),
      updated_at: new Date().toISOString()
    });

  return newSession;
}

// Guardar sesi√≥n
async function saveSession(session: UserSession, supabase: any): Promise<void> {
  await supabase
    .from('user_sessions')
    .upsert({
      phone: session.phone,
      previous_state: session.state,
      last_bot_message: JSON.stringify(session.context || {}),
      updated_at: new Date().toISOString()
    });
}

export async function handleVendorBot(
  message: string,
  phone: string,
  supabase: any
): Promise<string> {
  const lowerMessage = message.toLowerCase().trim();

  // COMANDOS GLOBALES - Disponibles en cualquier momento
  
  // Ayuda - Mostrar informaci√≥n y enlace a web
  if (lowerMessage === 'ayuda' || lowerMessage === 'help' || lowerMessage === 'info') {
    return `‚ÑπÔ∏è *CENTRO DE AYUDA*\n\n` +
           `üåê *Visita nuestra web:*\n` +
           `https://tu-sitio.lovable.app\n\n` +
           `üì± *Comandos √∫tiles:*\n` +
           `‚Ä¢ *menu* - Ver men√∫ principal\n` +
           `‚Ä¢ *vendedor* - Hablar con alguien\n` +
           `‚Ä¢ *ofertas* - Ver promociones\n` +
           `‚Ä¢ *volver* - Regresar\n` +
           `‚Ä¢ *salir* - Cerrar conversaci√≥n actual\n\n` +
           `üí° Tambi√©n puedes escribir directamente lo que buscas:\n` +
           `Ejemplo: "pizza", "hamburguesa"`;
  }

  // Menu - Volver al men√∫ principal
  if (lowerMessage === 'menu' || lowerMessage === 'inicio' || lowerMessage === 'empezar') {
    const session = await getSession(phone, supabase);
    session.state = 'MAIN_MENU';
    session.context = {};
    await saveSession(session, supabase);
    return await getMainMenu(phone, supabase);
  }

  // Salir - Cerrar conversaci√≥n actual
  if (lowerMessage === 'salir' || lowerMessage === 'cancelar') {
    const session = await getSession(phone, supabase);
    
    // Si est√° en vendor chat, cerrarlo
    const { data: activeChat } = await supabase
      .from('vendor_chats')
      .select('*')
      .eq('customer_phone', phone)
      .eq('is_active', true)
      .maybeSingle();

    if (activeChat) {
      await supabase
        .from('vendor_chats')
        .update({ is_active: false, ended_at: new Date().toISOString() })
        .eq('id', activeChat.id);
    }

    session.state = 'MAIN_MENU';
    session.context = {};
    await saveSession(session, supabase);
    
    return `‚úÖ Conversaci√≥n cerrada.\n\n` +
           `Escribe *menu* para ver opciones o *ayuda* para m√°s informaci√≥n.`;
  }

  // Volver - Regresar al estado anterior
  if (lowerMessage === 'volver' || lowerMessage === 'atras' || lowerMessage === 'regresar') {
    const session = await getSession(phone, supabase);
    session.state = 'MAIN_MENU';
    await saveSession(session, supabase);
    return await getMainMenu(phone, supabase);
  }

  // Vendedor - Siempre disponible, escapar a chat humano
  if (lowerMessage.includes('vendedor') || lowerMessage.includes('hablar') || lowerMessage === '3') {
    return await startVendorChat(phone, supabase);
  }

  // Verificar si est√° en vendor chat activo
  const { data: activeChat } = await supabase
    .from('vendor_chats')
    .select('*')
    .eq('customer_phone', phone)
    .eq('is_active', true)
    .maybeSingle();

  if (activeChat) {
    // Guardar mensaje para el vendedor
    await supabase
      .from('chat_messages')
      .insert({
        chat_id: activeChat.id,
        sender_type: 'customer',
        message: message
      });
    
    return `üì© *Mensaje enviado al vendedor*\n\n` +
           `Contin√∫a escribiendo o usa:\n` +
           `‚Ä¢ *salir* - Terminar chat\n` +
           `‚Ä¢ *menu* - Volver al men√∫`;
  }

  // Obtener sesi√≥n actual
  const session = await getSession(phone, supabase);

  // OFERTAS
  if (lowerMessage === '1' || lowerMessage.includes('ofertas') || lowerMessage.includes('promociones')) {
    session.state = 'BROWSING_OFFERS';
    await saveSession(session, supabase);
    return await getActiveOffers(phone, supabase);
  }

  // HACER PEDIDO
  if (lowerMessage === '2' || 
      lowerMessage.includes('pedir') || 
      lowerMessage.includes('quiero') ||
      lowerMessage.includes('ordenar') ||
      lowerMessage.includes('comprar')) {
    session.state = 'ORDERING';
    await saveSession(session, supabase);
    return await initiateOrder(message, phone, supabase);
  }

  // HORARIOS (solo si hace sentido)
  if (lowerMessage === '4' || lowerMessage.includes('horario') || lowerMessage.includes('abierto')) {
    session.state = 'VIEWING_HOURS';
    await saveSession(session, supabase);
    return await getVendorHours(phone, supabase);
  }

  // ESTADO DEL PEDIDO (solo si tiene pedidos activos)
  if (lowerMessage === '5' || lowerMessage.includes('estado') || lowerMessage.includes('mi pedido')) {
    session.state = 'TRACKING_ORDER';
    await saveSession(session, supabase);
    return await getOrderStatus(phone, supabase);
  }

  // CALIFICAR (solo si tiene pedidos completados)
  if (lowerMessage === '6' || lowerMessage.startsWith('calificar') || lowerMessage.startsWith('review')) {
    session.state = 'RATING';
    await saveSession(session, supabase);
    return await handleReview(message, phone, supabase);
  }

  // B√öSQUEDA INTELIGENTE - Si escribe algo que parece un producto
  if (lowerMessage.length > 3 && !lowerMessage.match(/^\d+$/)) {
    const searchResult = await smartProductSearch(message, phone, supabase);
    if (searchResult) {
      session.state = 'BROWSING_OFFERS';
      await saveSession(session, supabase);
      return searchResult;
    }
  }

  // Si escribi√≥ solo "hola" o saludo, mostrar men√∫
  if (lowerMessage === 'hola' || lowerMessage === 'hi' || lowerMessage === 'buenos dias' || 
      lowerMessage === 'buenas tardes' || lowerMessage === 'buenas noches') {
    return await getMainMenu(phone, supabase);
  }

  // Por defecto, si no entendi√≥ nada, mostrar men√∫ con sugerencia
  return `ü§î No estoy seguro de entender.\n\n` +
         `üí° *Puedes:*\n` +
         `‚Ä¢ Escribir *menu* para ver opciones\n` +
         `‚Ä¢ Escribir *vendedor* para hablar con alguien\n` +
         `‚Ä¢ Escribir *ayuda* para m√°s informaci√≥n\n` +
         `‚Ä¢ O buscar directamente: "pizza", "hamburguesa"`;
}

async function smartProductSearch(message: string, phone: string, supabase: any): Promise<string | null> {
  try {
    const searchTerm = message.toLowerCase().trim();
    
    // Buscar en productos
    const { data: products } = await supabase
      .from('products')
      .select('*, vendors!inner(id, name, is_active)')
      .eq('is_available', true)
      .eq('vendors.is_active', true)
      .or(`name.ilike.%${searchTerm}%,description.ilike.%${searchTerm}%,category.ilike.%${searchTerm}%`)
      .limit(5);
    
    if (!products || products.length === 0) {
      return null;
    }
    
    let response = `üîç *Encontr√© ${products.length} resultado(s) para "${searchTerm}":*\n\n`;
    
    products.forEach((p: any, index: number) => {
      response += `${index + 1}. *${p.name}* - $${p.price}\n`;
      response += `   üìç ${p.vendors.name}\n`;
      if (p.description) response += `   ${p.description}\n`;
      response += '\n';
    });
    
    response += `üí¨ *Para ordenar:*\n`;
    response += `‚Ä¢ Escribe *vendedor* para asistencia personalizada\n`;
    response += `‚Ä¢ Escribe *menu* para m√°s opciones\n`;
    response += `‚Ä¢ Escribe *volver* para regresar`;
    
    return response;
  } catch (e) {
    return null;
  }
}

async function initiateOrder(message: string, phone: string, supabase: any): Promise<string> {
  return `üì¶ *¬°Perfecto! Hagamos tu pedido*\n\n` +
         `Tienes 2 formas de hacerlo:\n\n` +
         `1Ô∏è‚É£ *ASISTENCIA PERSONAL*\n` +
         `   Escribe *vendedor* y te ayudamos paso a paso\n\n` +
         `2Ô∏è‚É£ *EXPLORAR*\n` +
         `   ‚Ä¢ Escribe *ofertas* para ver promociones\n` +
         `   ‚Ä¢ O busca directamente: "pizza", "hamburguesa"\n\n` +
         `üí° *Comandos √∫tiles:*\n` +
         `‚Ä¢ *menu* - Volver al men√∫\n` +
         `‚Ä¢ *volver* - Regresar\n` +
         `‚Ä¢ *ayuda* - Ver m√°s opciones`;
}

async function getMainMenu(phone: string, supabase: any): Promise<string> {
  try {
    // Verificar pedidos activos
    const { data: activeOrders } = await supabase
      .from('orders')
      .select('id')
      .eq('customer_phone', phone)
      .in('status', ['pending', 'confirmed', 'preparing', 'in_transit'])
      .limit(1);

    const hasActiveOrders = activeOrders && activeOrders.length > 0;

    // Verificar pedidos completados
    const { data: completedOrders } = await supabase
      .from('orders')
      .select('id')
      .eq('customer_phone', phone)
      .eq('status', 'delivered')
      .order('created_at', { ascending: false })
      .limit(1);

    const hasCompletedOrders = completedOrders && completedOrders.length > 0;

    let message = `üëã *¬°Bienvenido!*\n\n` +
                  `Soy tu asistente virtual.\n\n` +
                  `üì± *OPCIONES DISPONIBLES:*\n\n` +
                  `1Ô∏è‚É£ Ver *ofertas* del d√≠a\n` +
                  `2Ô∏è‚É£ *Hacer pedido* (describe lo que necesitas)\n` +
                  `3Ô∏è‚É£ *Hablar con vendedor* üí¨\n` +
                  `4Ô∏è‚É£ Ver *horarios* de atenci√≥n\n`;

    if (hasActiveOrders) {
      message += `5Ô∏è‚É£ Ver *estado* de tu pedido\n`;
    }

    if (hasCompletedOrders) {
      message += `6Ô∏è‚É£ *Calificar* servicio\n`;
    }

    message += `\nüí° *TIPS:*\n`;
    message += `‚Ä¢ Escribe el n√∫mero de opci√≥n (1, 2, 3...)\n`;
    message += `‚Ä¢ O busca directamente: "pizza", "hamburguesa"\n`;
    message += `‚Ä¢ Escribe *ayuda* para m√°s informaci√≥n\n`;
    message += `‚Ä¢ Escribe *vendedor* en cualquier momento para ayuda personalizada`;

    return message;
  } catch (e) {
    return `üëã *¬°Bienvenido!*\n\n` +
           `üì± *MEN√ö:*\n` +
           `1Ô∏è‚É£ Ofertas\n` +
           `2Ô∏è‚É£ Hacer pedido\n` +
           `3Ô∏è‚É£ Hablar con vendedor üí¨\n\n` +
           `üí° Escribe *vendedor* para ayuda personalizada\n` +
           `üìñ Escribe *ayuda* para m√°s opciones`;
  }
}

async function getActiveOffers(phone: string, supabase: any): Promise<string> {
  try {
    const { data: offers } = await supabase
      .from('vendor_offers')
      .select('*, vendors(name)')
      .eq('is_active', true)
      .gte('valid_until', new Date().toISOString())
      .limit(5);

    if (!offers || offers.length === 0) {
      return `üòï *No hay ofertas activas ahora*\n\n` +
             `üí° *Opciones:*\n` +
             `‚Ä¢ Escribe *vendedor* para consultar\n` +
             `‚Ä¢ Escribe *menu* para m√°s opciones\n` +
             `‚Ä¢ Busca productos: "pizza", "hamburguesa"`;
    }

    let message = 'üéâ *OFERTAS ESPECIALES* üéâ\n\n';

    offers.forEach((offer: any, index: number) => {
      message += `${index + 1}. *${offer.title}*\n`;
      message += `   üìç ${offer.vendors.name}\n`;
      message += `   ${offer.description}\n`;

      if (offer.discount_percentage) {
        message += `   üè∑Ô∏è *${offer.discount_percentage}% OFF*\n`;
      }

      if (offer.original_price && offer.offer_price) {
        message += `   üí∞ ~$${offer.original_price}~ *$${offer.offer_price}*\n`;
      }

      message += '\n';
    });

    message += `üí¨ *Para ordenar:*\n`;
    message += `‚Ä¢ Escribe *vendedor* para asistencia\n`;
    message += `‚Ä¢ Escribe *menu* para m√°s opciones\n`;
    message += `‚Ä¢ Escribe *volver* para regresar`;

    return message;
  } catch (e) {
    return fallbackMessage();
  }
}

async function startVendorChat(phone: string, supabase: any): Promise<string> {
  try {
    // Verificar si ya tiene un chat activo
    const { data: existingChat } = await supabase
      .from('vendor_chats')
      .select('*')
      .eq('customer_phone', phone)
      .eq('is_active', true)
      .maybeSingle();

    if (existingChat) {
      return `üí¨ *Ya tienes un chat activo*\n\n` +
             `Contin√∫a escribiendo y el vendedor ver√° tus mensajes.\n\n` +
             `üí° *Comandos √∫tiles:*\n` +
             `‚Ä¢ *salir* - Terminar chat\n` +
             `‚Ä¢ *menu* - Volver al men√∫\n` +
             `‚Ä¢ *ayuda* - Ver m√°s opciones`;
    }

    // Buscar vendor activo
    const { data: vendor } = await supabase
      .from('vendors')
      .select('id, name')
      .eq('is_active', true)
      .limit(1)
      .maybeSingle();

    if (!vendor) {
      return `üòï *No hay vendedores disponibles en este momento*\n\n` +
             `üí° *Opciones:*\n` +
             `‚Ä¢ Escribe *menu* para ver otras opciones\n` +
             `‚Ä¢ Intenta m√°s tarde\n` +
             `‚Ä¢ Escribe *ayuda* para m√°s informaci√≥n`;
    }

    // Crear chat
    const { data: chat, error } = await supabase
      .from('vendor_chats')
      .insert({
        vendor_id: vendor.id,
        customer_phone: phone,
        is_active: true
      })
      .select()
      .single();

    if (error) {
      return `‚ùå *Error al iniciar chat*\n\n` +
             `‚Ä¢ Escribe *menu* para ver otras opciones\n` +
             `‚Ä¢ Intenta nuevamente en un momento`;
    }

    // Mensaje inicial
    await supabase
      .from('chat_messages')
      .insert({
        chat_id: chat.id,
        sender_type: 'system',
        message: `Cliente ${phone} ha iniciado un chat`
      });

    return `‚úÖ *Chat iniciado con ${vendor.name}*\n\n` +
           `üéØ *Ahora puedes escribir libremente*\n` +
           `Un vendedor te atender√° pronto.\n\n` +
           `üí≠ *Ejemplos de consultas:*\n` +
           `‚Ä¢ "¬øTienen pizza de pepperoni?"\n` +
           `‚Ä¢ "Quiero hacer un pedido de..."\n` +
           `‚Ä¢ "¬øEntregan a [tu zona]?"\n` +
           `‚Ä¢ "¬øCu√°nto demora el delivery?"\n\n` +
           `üí° *Comandos √∫tiles:*\n` +
           `‚Ä¢ *salir* - Terminar chat\n` +
           `‚Ä¢ *menu* - Volver al men√∫\n` +
           `‚Ä¢ *ayuda* - Ver m√°s informaci√≥n`;
  } catch (e) {
    return fallbackMessage();
  }
}

async function handleReview(message: string, phone: string, supabase: any): Promise<string> {
  try {
    const parts = message.split(' ');
    const rating = parseInt(parts[1]);

    if (!rating || rating < 1 || rating > 5) {
      return `‚≠ê *CALIFICAR SERVICIO*\n\n` +
             `üìù *Formato:*\n` +
             `calificar [1-5] [comentario opcional]\n\n` +
             `*Ejemplos:*\n` +
             `‚Ä¢ calificar 5 Excelente servicio\n` +
             `‚Ä¢ calificar 4\n` +
             `‚Ä¢ calificar 3 Lleg√≥ un poco tarde\n\n` +
             `üí° *Comandos √∫tiles:*\n` +
             `‚Ä¢ *vendedor* - Hablar con alguien\n` +
             `‚Ä¢ *menu* - Ver m√°s opciones\n` +
             `‚Ä¢ *volver* - Regresar`;
    }

    const comment = parts.slice(2).join(' ');

    const { data: lastOrder } = await supabase
      .from('orders')
      .select('vendor_id')
      .eq('customer_phone', phone)
      .eq('status', 'delivered')
      .order('created_at', { ascending: false })
      .limit(1)
      .maybeSingle();

    if (!lastOrder) {
      return `üòï *No encontramos pedidos completados para calificar*\n\n` +
             `üí° *Opciones:*\n` +
             `‚Ä¢ Escribe *vendedor* si crees que hay un error\n` +
             `‚Ä¢ Escribe *menu* para m√°s opciones`;
    }

    const { error } = await supabase
      .from('vendor_reviews')
      .insert({
        vendor_id: lastOrder.vendor_id,
        customer_phone: phone,
        rating: rating,
        comment: comment || null
      });

    if (error) {
      return `‚ùå *Error al guardar calificaci√≥n*\n\n` +
             `‚Ä¢ Escribe *vendedor* para reportar el problema\n` +
             `‚Ä¢ Escribe *menu* para m√°s opciones`;
    }

    const stars = '‚≠ê'.repeat(rating);
    return `‚úÖ *¬°Gracias por tu calificaci√≥n!*\n\n` +
           `${stars}\n` +
           `${comment ? `"${comment}"` : ''}\n\n` +
           `Tu opini√≥n nos ayuda a mejorar.\n\n` +
           `üí° *Siguientes pasos:*\n` +
           `‚Ä¢ Escribe *menu* para m√°s opciones\n` +
           `‚Ä¢ Escribe *ofertas* para ver promociones\n` +
           `‚Ä¢ Escribe *vendedor* para asistencia`;
  } catch (e) {
    return fallbackMessage();
  }
}

async function getVendorHours(phone: string, supabase: any): Promise<string> {
  try {
    const { data: vendors } = await supabase
      .from('vendors')
      .select('name, opening_time, closing_time, days_open')
      .eq('is_active', true);

    if (!vendors || vendors.length === 0) {
      return `üòï *No hay informaci√≥n de horarios disponible*\n\n` +
             `üí° *Opciones:*\n` +
             `‚Ä¢ Escribe *vendedor* para consultar\n` +
             `‚Ä¢ Escribe *menu* para ver m√°s opciones`;
    }

    let message = 'üïê *HORARIOS DE ATENCI√ìN*\n\n';

    vendors.forEach((vendor: any) => {
      message += `üìç *${vendor.name}*\n`;
      message += `   ‚è∞ ${vendor.opening_time} - ${vendor.closing_time}\n`;
      message += `   üìÖ ${vendor.days_open?.join(', ') || 'Todos los d√≠as'}\n\n`;
    });

    message += `üí¨ *Siguientes pasos:*\n`;
    message += `‚Ä¢ Escribe *vendedor* para hacer un pedido\n`;
    message += `‚Ä¢ Escribe *ofertas* para ver promociones\n`;
    message += `‚Ä¢ Escribe *menu* para m√°s opciones\n`;
    message += `‚Ä¢ Escribe *volver* para regresar`;

    return message;
  } catch (e) {
    return fallbackMessage();
  }
}

async function getOrderStatus(phone: string, supabase: any): Promise<string> {
  try {
    const { data: orders } = await supabase
      .from('orders')
      .select('id, status, created_at, total')
      .eq('customer_phone', phone)
      .in('status', ['pending', 'confirmed', 'preparing', 'in_transit'])
      .order('created_at', { ascending: false })
      .limit(3);

    if (!orders || orders.length === 0) {
      return `üì¶ *No tienes pedidos activos*\n\n` +
             `üí° *Opciones:*\n` +
             `‚Ä¢ Escribe *vendedor* para hacer un pedido\n` +
             `‚Ä¢ Escribe *ofertas* para ver promociones\n` +
             `‚Ä¢ Escribe *menu* para m√°s opciones`;
    }

    let message = 'üì¶ *TUS PEDIDOS ACTIVOS*\n\n';

    orders.forEach((order: any, index: number) => {
      const statusEmoji = {
        'pending': '‚è≥',
        'confirmed': '‚úÖ',
        'preparing': 'üë®‚Äçüç≥',
        'in_transit': 'üöö',
      }[order.status] || 'üìã';

      const statusText = {
        'pending': 'Pendiente',
        'confirmed': 'Confirmado',
        'preparing': 'En preparaci√≥n',
        'in_transit': 'En camino',
      }[order.status] || order.status;

      message += `${index + 1}. ${statusEmoji} *${statusText}*\n`;
      message += `   üí∞ Total: $${order.total}\n`;
      message += `   üìÖ ${new Date(order.created_at).toLocaleString('es-AR')}\n\n`;
    });

    message += `üí¨ *¬øNecesitas ayuda?*\n`;
    message += `‚Ä¢ Escribe *vendedor* para hablar con alguien\n`;
    message += `‚Ä¢ Escribe *menu* para m√°s opciones\n`;
    message += `‚Ä¢ Escribe *volver* para regresar`;

    return message;
  } catch (e) {
    return `‚ùå *Error al consultar pedidos*\n\n` +
           `‚Ä¢ Escribe *vendedor* para ayuda\n` +
           `‚Ä¢ Escribe *menu* para m√°s opciones`;
  }
}

function fallbackMessage(): string {
  return `ü§î *No entend√≠ tu mensaje*\n\n` +
         `üí° *Puedes intentar:*\n` +
         `‚Ä¢ Escribir *menu* para ver todas las opciones\n` +
         `‚Ä¢ Escribir *vendedor* para hablar con alguien\n` +
         `‚Ä¢ Escribir *ayuda* para m√°s informaci√≥n\n` +
         `‚Ä¢ Buscar productos: "pizza", "hamburguesa", etc.`;
}